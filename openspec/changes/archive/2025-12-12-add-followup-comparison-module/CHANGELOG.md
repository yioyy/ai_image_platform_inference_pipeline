# Follow-up 比較模組變更日誌

## 2025-11-28 - 重大重新規劃

### 變更原因
根據用戶反饋，調整專案範圍以符合現有系統架構：
- **不使用資料庫**：改為純檔案導向的處理管道
- **簡化輸入方式**：直接提供兩次檢查的檔案路徑
- **參考現有架構**：遵循 `pipeline_infarct_torch.py` 的設計模式
- **明確輸出範圍**：只到上傳 DICOM 和 JSON 為止

### 主要變更

#### ❌ 移除的功能
1. **資料庫設計**
   - 刪除 `followup_comparisons` 資料表
   - 刪除 `lesion_tracking` 資料表
   - 移除所有資料庫遷移腳本

2. **自動配對引擎**
   - 移除歷史檢查查詢功能
   - 移除自動配對推薦功能
   - 改為由使用者明確指定兩次檢查

3. **Web API 層**
   - 移除 `followup_api.py`
   - 移除 RESTful API 端點
   - 移除批次處理 API

4. **前端界面**
   - 移除所有前端整合任務
   - 改為命令列工具

5. **複雜功能**
   - 移除非剛性配準（保留剛性配準）
   - 移除 3D 渲染（保留 2D 視覺化）
   - 移除 PDF 報告（保留 JSON 報告）
   - 移除多時間點比較（保留兩時間點）

#### ✅ 保留的核心功能
1. **影像配準** (SimpleITK)
   - 剛性配準（6 自由度）
   - 配準品質評估
   - 配準結果視覺化

2. **病灶變化分析**
   - 病灶提取與配對
   - 新增/消失病灶檢測
   - 體積變化計算
   - 五種狀態分類

3. **視覺化輸出**
   - 並排影像比較
   - 差異熱力圖
   - 病灶疊加標記
   - 統計圖表

4. **結果輸出**
   - JSON 報告
   - DICOM-SEG 檔案
   - 上傳至 Orthanc

### 新的系統架構

#### 輸入方式
```bash
python pipeline_followup.py \
  --baseline_ID "01550089_20251117_MR_21411150023" \
  --baseline_Inputs Pred.nii.gz ADC.nii.gz DWI0.nii.gz DWI1000.nii.gz \
  --baseline_DicomDir ADC_dir/ DWI0_dir/ DWI1000_dir/ \
  --followup_ID "01550089_20260317_MR_21511160033" \
  --followup_Inputs Pred.nii.gz ADC.nii.gz DWI0.nii.gz DWI1000.nii.gz \
  --followup_DicomDir ADC_dir/ DWI0_dir/ DWI1000_dir/ \
  --Output_folder /output/path/
```

#### 處理流程
1. **Stage 1: 載入與驗證** - 檢查輸入檔案，創建資料夾
2. **Stage 2: 影像配準** - SimpleITK 剛性配準
3. **Stage 3: 病灶分析** - 病灶配對、變化計算
4. **Stage 4: 結果輸出** - 視覺化、JSON、DICOM-SEG

#### 檔案結構
```
process/Followup/{comparison_ID}/
├── baseline/         # 基準檢查檔案
├── followup/         # 追蹤檢查檔案（含配準後）
├── registration/     # 配準結果
├── analysis/         # 分析結果
├── visualization/    # 視覺化圖片
└── dicom/            # DICOM 檔案
```

### 任務數量變化

| 類別 | 原版本 | 新版本 | 變化 |
|------|--------|--------|------|
| 資料庫 | 5 | 0 | -5 |
| 配對引擎 | 5 | 0 | -5 |
| 配準模組 | 7 | 5 | -2 |
| 病灶分析 | 7 | 7 | 0 |
| 視覺化 | 6 | 5 | -1 |
| 報告生成 | 6 | 4 | -2 |
| API 開發 | 6 | 0 | -6 |
| 前端整合 | 4 | 0 | -4 |
| 主管道 | 4 | 8 | +4 |
| Shell 腳本 | 0 | 2 | +2 |
| 測試 | 5 | 4 | -1 |
| 文檔 | 5 | 4 | -1 |
| 其他 | 36 | 26 | -10 |
| **總計** | **96** | **65** | **-31** |

### 時程變化

| 階段 | 原時程 | 新時程 | 變化 |
|------|--------|--------|------|
| 核心功能 | 3 週 | 2 週 | -1 週 |
| 視覺化與報告 | 2 週 | 1 週 | -1 週 |
| 整合與測試 | 2 週 | 1 週 | -1 週 |
| 臨床驗證 | 1 週 | 1 週（選用）| 0 |
| **總計** | **8 週** | **4-5 週** | **-3~4 週** |

### 驗收標準調整

#### 功能需求（調整）
- ~~自動配對準確率 >95%~~ → 移除
- 配準 MI 分數：0.8 → **0.7**（放寬標準）
- 病灶配對準確率：90% → **85%**（放寬標準）
- 體積測量誤差：5% → **10%**（放寬標準）

#### 新增需求
- ✅ 接受兩組檢查資料並成功執行
- ✅ 產生完整 JSON 報告
- ✅ 產生 DICOM-SEG 檔案
- ✅ 成功上傳至 Orthanc

### 技術決策

#### 為什麼移除資料庫？
- 與現有系統（pipeline_infarct_torch.py）保持一致
- 簡化部署與維護
- 所有資料以檔案形式儲存，便於追蹤與除錯
- 未來如需資料庫可作為獨立擴展

#### 為什麼移除自動配對？
- 由使用者/排程系統決定哪兩次檢查要比較
- 避免配對邏輯的複雜性與潛在錯誤
- 更符合實際臨床工作流程

#### 為什麼簡化視覺化？
- 2D 視覺化已足夠臨床使用
- 3D 渲染需要額外依賴（VTK/Plotly）
- 可作為未來擴展功能

### 依賴項目變化

#### 移除的依賴
- ~~reportlab~~ - PDF 報告生成
- ~~plotly~~ - 互動式圖表
- ~~MySQL 相關~~ - 資料庫

#### 保留的依賴
- SimpleITK - 影像配準
- scipy - 科學計算
- scikit-image - 影像處理
- matplotlib - 圖表繪製

### 相容性

#### 與現有系統整合
- ✅ 完全獨立運作，不影響現有管道
- ✅ 可重用部分工具函數
- ✅ 輸出格式與現有系統一致
- ✅ 使用相同的 DICOM 處理邏輯

#### 擴展性
未來可選擇性新增：
1. 資料庫整合（記錄比較歷史）
2. Web 界面查看結果
3. 批次處理多個患者
4. PDF 報告生成
5. 3D 視覺化渲染

### 下一步行動

1. ✅ 審查新版提案
2. ⏸️ 批准實作計畫
3. ⏸️ 開始 Phase 1 開發（配準與分析模組）
4. ⏸️ 整合測試
5. ⏸️ 臨床驗證

---

**更新者**: AI Assistant  
**審查者**: [待指派]  
**批准者**: [待指派]

