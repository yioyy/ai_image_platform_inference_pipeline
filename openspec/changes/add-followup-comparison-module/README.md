# Follow-up æ¯”è¼ƒæ¨¡çµ„è®Šæ›´ææ¡ˆ

## è®Šæ›´æ¦‚è¿°
é–‹ç™¼æª”æ¡ˆå°å‘çš„å‰å¾Œæª¢æŸ¥æ¯”è¼ƒç®¡é“ï¼Œé¡ä¼¼ `pipeline_infarct_torch.py` çš„æ¶æ§‹ï¼Œç”¨æ–¼è¿½è¹¤æ‚£è€…ç—…æƒ…è®ŠåŒ–ã€‚

## ğŸ“ è®Šæ›´çµæ§‹

```
add-followup-comparison-module/
â”œâ”€â”€ README.md           # æœ¬æª”æ¡ˆ
â”œâ”€â”€ proposal.md         # è©³ç´°è®Šæ›´ææ¡ˆ
â”œâ”€â”€ tasks.md            # 75 é …å¯¦ä½œä»»å‹™ï¼ˆç°¡åŒ–ç‰ˆï¼‰
â””â”€â”€ specs/
    â””â”€â”€ followup/
        â””â”€â”€ spec.md     # å®Œæ•´è¦æ ¼å¢é‡
```

## ğŸ¯ æ ¸å¿ƒåŠŸèƒ½

### 1. è¼¸å…¥è³‡æ–™è™•ç†
- æ¥å—å…©çµ„æª¢æŸ¥è³‡æ–™ï¼ˆbaseline èˆ‡ followupï¼‰
- æª”æ¡ˆå®Œæ•´æ€§é©—è­‰
- å‰µå»ºæ¨™æº–è™•ç†è³‡æ–™å¤¾

### 2. ç²¾ç¢ºå½±åƒé…æº–
- å¤šè§£æåº¦å‰›æ€§é…æº–
- é…æº–å“è³ªè‡ªå‹•è©•ä¼°
- å¿«é€Ÿé è¦½æ¨¡å¼

### 3. ç—…ç¶è®ŠåŒ–è¿½è¹¤
- è‡ªå‹•ç—…ç¶é…å°
- æ–°å¢/æ¶ˆå¤±ç—…ç¶æª¢æ¸¬
- é«”ç©è®ŠåŒ–ç²¾ç¢ºè¨ˆç®—
- äº”ç¨®ç‹€æ…‹åˆ†é¡ï¼ˆç©©å®šã€å¢å¤§ã€ç¸®å°ã€æ–°å¢ã€æ¶ˆå¤±ï¼‰

### 4. è±å¯Œè¦–è¦ºåŒ–
- ä¸¦æ’å½±åƒå°æ¯”
- ç†±åŠ›åœ–å·®ç•°é¡¯ç¤º
- 3D ç—…ç¶æ¸²æŸ“
- çµ±è¨ˆåœ–è¡¨

### 5. å°ˆæ¥­å ±å‘Šç”Ÿæˆ
- æ–‡å­—å ±å‘Šï¼ˆMarkdown/HTMLï¼‰
- PDF å ±å‘Š
- DICOM-SR çµæ§‹åŒ–å ±å‘Š
- è‡ªå‹•çµè«–èˆ‡å»ºè­°

## ğŸ“ æª”æ¡ˆçµæ§‹è¨­è¨ˆ

### è™•ç†è³‡æ–™å¤¾çµæ§‹
```
process/Followup/{comparison_ID}/
â”œâ”€â”€ baseline/            # åŸºæº–æª¢æŸ¥è³‡æ–™
â”‚   â”œâ”€â”€ Pred.nii.gz
â”‚   â”œâ”€â”€ ADC.nii.gz
â”‚   â”œâ”€â”€ DWI0.nii.gz
â”‚   â””â”€â”€ DWI1000.nii.gz
â”œâ”€â”€ followup/            # è¿½è¹¤æª¢æŸ¥è³‡æ–™
â”‚   â”œâ”€â”€ Pred.nii.gz
â”‚   â”œâ”€â”€ Pred_registered.nii.gz
â”‚   â”œâ”€â”€ ADC_registered.nii.gz
â”‚   â””â”€â”€ ...
â”œâ”€â”€ registration/        # é…æº–çµæœ
â”‚   â”œâ”€â”€ transform.tfm
â”‚   â””â”€â”€ registration_quality.txt
â”œâ”€â”€ analysis/            # åˆ†æçµæœ
â”‚   â”œâ”€â”€ lesion_matching.json
â”‚   â””â”€â”€ statistics.json
â”œâ”€â”€ visualization/       # è¦–è¦ºåŒ–åœ–ç‰‡
â”‚   â”œâ”€â”€ side_by_side.png
â”‚   â”œâ”€â”€ difference_map.png
â”‚   â””â”€â”€ volume_chart.png
â””â”€â”€ dicom/               # DICOM æª”æ¡ˆ
    â”œâ”€â”€ baseline/
    â”œâ”€â”€ followup/
    â””â”€â”€ comparison_seg.dcm
```

## ğŸ—ï¸ ç³»çµ±æ¶æ§‹ï¼ˆæª”æ¡ˆå°å‘ï¼‰

```
pipeline_followup.py (ä¸»è…³æœ¬)
    â†“
Stage 1: è¼‰å…¥èˆ‡é©—è­‰
    â”œâ”€â”€ é©—è­‰è¼¸å…¥æª”æ¡ˆ
    â”œâ”€â”€ å‰µå»ºè™•ç†è³‡æ–™å¤¾
    â””â”€â”€ è¤‡è£½è¼¸å…¥æª”æ¡ˆ
    â†“
Stage 2: å½±åƒé…æº– (registration.py)
    â”œâ”€â”€ SimpleITK é…æº–
    â”œâ”€â”€ é…æº–å“è³ªè©•ä¼°
    â””â”€â”€ æ‡‰ç”¨é…æº–è®Šæ›
    â†“
Stage 3: ç—…ç¶è®ŠåŒ–åˆ†æ (lesion_analysis.py)
    â”œâ”€â”€ ç—…ç¶æå–èˆ‡é…å°
    â”œâ”€â”€ è®ŠåŒ–è¨ˆç®—
    â””â”€â”€ ç‹€æ…‹åˆ†é¡
    â†“
Stage 4: çµæœè¼¸å‡º
    â”œâ”€â”€ è¦–è¦ºåŒ– (followup_visualization.py)
    â”œâ”€â”€ JSON å ±å‘Š (followup_report.py)
    â”œâ”€â”€ DICOM-SEG (dicom_followup.py)
    â””â”€â”€ ä¸Šå‚³ Orthanc
```

## ğŸ“ˆ å¯¦ä½œé€²åº¦

### éšæ®µ 1: æ ¸å¿ƒæ¨¡çµ„é–‹ç™¼ (Week 1-2)
- [ ] å½±åƒé…æº–æ¨¡çµ„
- [ ] ç—…ç¶åˆ†ææ¨¡çµ„
- [ ] æª”æ¡ˆè™•ç†é‚è¼¯

### éšæ®µ 2: è¼¸å‡ºåŠŸèƒ½ (Week 3)
- [ ] è¦–è¦ºåŒ–å·¥å…·
- [ ] JSON å ±å‘Šç”Ÿæˆ
- [ ] DICOM-SEG ç”Ÿæˆ

### éšæ®µ 3: æ•´åˆèˆ‡æ¸¬è©¦ (Week 4)
- [ ] ä¸»ç®¡é“è…³æœ¬æ•´åˆ
- [ ] å–®å…ƒèˆ‡æ•´åˆæ¸¬è©¦
- [ ] æ–‡æª”æ’°å¯«

### éšæ®µ 4: è‡¨åºŠé©—è­‰ (Week 5ï¼Œé¸ç”¨)
- [ ] çœŸå¯¦æ¡ˆä¾‹æ¸¬è©¦
- [ ] æ•ˆèƒ½å„ªåŒ–
- [ ] æœ€çµ‚èª¿æ•´

## ğŸ“ æŠ€è¡“äº®é»

### å…ˆé€²çš„é…æº–æŠ€è¡“
- ä½¿ç”¨ **SimpleITK** é†«å­¸å½±åƒé…æº–åº«
- å¤šè§£æåº¦é‡‘å­—å¡”ç­–ç•¥
- è‡ªå‹•é…æº–å“è³ªè©•ä¼°ï¼ˆMutual Informationï¼‰

### æ™ºèƒ½ç—…ç¶è¿½è¹¤
- å¤šç‰¹å¾µé…å°ï¼ˆç©ºé–“è·é›¢ + é«”ç© + å½¢ç‹€ï¼‰
- ä¿¡å¿ƒåº¦é‡åŒ–
- é‚Šç•Œæ¡ˆä¾‹ç‰¹æ®Šè™•ç†

### è‡¨åºŠå°å‘è¨­è¨ˆ
- ç¬¦åˆè‡¨åºŠå·¥ä½œæµç¨‹
- æ¸…æ™°çš„è¦–è¦ºåŒ–å±•ç¤º
- å°ˆæ¥­çš„å ±å‘Šè¼¸å‡º
- DICOM æ¨™æº–åˆè¦

## ğŸ“ é—œéµæª”æ¡ˆèªªæ˜

### proposal.md
**å…§å®¹**:
- è‡¨åºŠèƒŒæ™¯èˆ‡éœ€æ±‚åˆ†æ
- æŠ€è¡“æ¶æ§‹è¨­è¨ˆ
- è³‡æ–™åº« Schema è¨­è¨ˆ
- é¢¨éšªè©•ä¼°èˆ‡ç·©è§£
- æ™‚ç¨‹ä¼°è¨ˆï¼ˆ8 é€±ï¼‰
- é©—æ”¶æ¨™æº–

**é©åˆé–±è®€å°è±¡**: æ‰€æœ‰åœ˜éšŠæˆå“¡ã€å°ˆæ¡ˆç¶“ç†ã€è‡¨åºŠé¡§å•

### tasks.md
**å…§å®¹**:
- 96 é …è©³ç´°ä»»å‹™
- 16 å€‹ä¸»è¦åˆ†é¡
- 4 å€‹é‡Œç¨‹ç¢‘
- å„ªå…ˆç´šæ¨™è¨˜ï¼ˆP0-P3ï¼‰

**é©åˆé–±è®€å°è±¡**: é–‹ç™¼äººå“¡ã€æŠ€è¡“ä¸»ç®¡

### specs/followup/spec.md
**å…§å®¹**:
- 45+ å€‹åŠŸèƒ½éœ€æ±‚
- 100+ å€‹å ´æ™¯å®šç¾©
- ä½¿ç”¨ MUST/SHALL/SHOULD èªæ³•
- WHEN/THEN æ¢ä»¶æè¿°

**é©åˆé–±è®€å°è±¡**: é–‹ç™¼äººå“¡ã€æ¸¬è©¦äººå“¡ã€å“è³ªä¿è­‰åœ˜éšŠ

## ğŸš€ å¦‚ä½•é–‹å§‹å¯¦ä½œ

### Step 1: å¯©æŸ¥ææ¡ˆ
```bash
# æŸ¥çœ‹å®Œæ•´ææ¡ˆ
openspec show add-followup-comparison-module

# æˆ–ç›´æ¥é–±è®€
cat openspec/changes/add-followup-comparison-module/proposal.md
```

### Step 2: é©—è­‰è¦æ ¼
```bash
# é©—è­‰è¦æ ¼æ ¼å¼
openspec validate add-followup-comparison-module
```

### Step 3: æº–å‚™ç’°å¢ƒ
```bash
# å®‰è£ä¾è³´
pip install SimpleITK>=2.2.0 scipy>=1.10.0 scikit-image>=0.20.0

# åŸ·è¡Œè³‡æ–™åº«é·ç§»
mysql -u user -p database < database_migration_followup.sql
```

### Step 4: é–‹å§‹å¯¦ä½œ
```bash
# ä½¿ç”¨ Cursor slash command
/openspec:apply add-followup-comparison-module

# æˆ–è‡ªç„¶èªè¨€
# "è«‹é–‹å§‹å¯¦ä½œ follow-up æ¯”è¼ƒæ¨¡çµ„"
```

## ğŸ¯ é©—æ”¶æ¨™æº–

### åŠŸèƒ½é©—æ”¶
- [ ] æ¥å—å…©çµ„æª¢æŸ¥è³‡æ–™ä¸¦æˆåŠŸåŸ·è¡Œ
- [ ] é…æº– MI åˆ†æ•¸ >0.7
- [ ] ç—…ç¶é…å°æº–ç¢ºç‡ >85%
- [ ] é«”ç©æ¸¬é‡èª¤å·® <10%
- [ ] ç”¢ç”Ÿå®Œæ•´ JSON å ±å‘Š
- [ ] ç”¢ç”Ÿ DICOM-SEG æª”æ¡ˆ
- [ ] æˆåŠŸä¸Šå‚³è‡³ Orthanc

### æ•ˆèƒ½é©—æ”¶
- [ ] é…æº–æ™‚é–“ <2 åˆ†é˜
- [ ] å®Œæ•´åˆ†æ <5 åˆ†é˜
- [ ] è¨˜æ†¶é«”ä½¿ç”¨ <4GB

### è‡¨åºŠé©—æ”¶ï¼ˆé¸ç”¨ï¼‰
- [ ] 10-20 å€‹çœŸå¯¦æ¡ˆä¾‹æ¸¬è©¦
- [ ] ç—…ç¶é…å°æº–ç¢ºæ€§é©—è­‰
- [ ] è‡¨åºŠå¯¦ç”¨æ€§è©•ä¼°

### ç¨‹å¼ç¢¼å“è³ª
- [ ] Linus é¢¨æ ¼æª¢æŸ¥é€šé
- [ ] æ ¸å¿ƒå‡½æ•¸åŒ…å«å–®å…ƒæ¸¬è©¦
- [ ] å®Œæ•´ä½¿ç”¨æ–‡æª”

## ğŸ’¡ è¨­è¨ˆæ±ºç­–

### ç‚ºä»€éº¼é¸æ“‡ SimpleITKï¼Ÿ
- å°ˆç‚ºé†«å­¸å½±åƒè¨­è¨ˆ
- æˆç†Ÿç©©å®šçš„é…æº–æ¼”ç®—æ³•
- æ”¯æ´å¤šç¨®é…æº–æ–¹æ³•
- èˆ‡ ITK ç”Ÿæ…‹ç³»çµ±æ•´åˆ

### ç‚ºä»€éº¼ä½¿ç”¨å¤šè§£æåº¦é…æº–ï¼Ÿ
- æå‡é…æº–é€Ÿåº¦
- é¿å…å±€éƒ¨æœ€å„ª
- æé«˜é…æº–æˆåŠŸç‡

### ç‚ºä»€éº¼è¨­è¨ˆå…©å€‹è³‡æ–™è¡¨ï¼Ÿ
- åˆ†é›¢ä¸»è¨˜éŒ„èˆ‡è©³ç´°è¿½è¹¤
- æ–¹ä¾¿æŸ¥è©¢èˆ‡åˆ†æ
- æ”¯æ´è¤‡é›œçš„ç—…ç¶é—œè¯æŸ¥è©¢

### ç‚ºä»€éº¼æ”¯æ´å¤šç¨®å ±å‘Šæ ¼å¼ï¼Ÿ
- æ–‡å­—å ±å‘Šï¼šå¿«é€Ÿå¯©é–±
- PDFï¼šæ­£å¼å ±å‘Šã€å­˜æª”
- DICOM-SRï¼šPACS æ•´åˆã€æ¨™æº–åŒ–

## ğŸ”— ç›¸é—œè³‡æº

### å…§éƒ¨æ–‡æª”
- [å°ˆæ¡ˆè¦ç¯„](../../project.md)
- [Linus é¢¨æ ¼æŒ‡å—](../../../.cursor/rules/linus.mdc)
- [AGENTS æŒ‡å—](../../../AGENTS.md)

### å­¸è¡“åƒè€ƒ
- **ANTs**: Advanced Normalization Tools
- **SimpleITK Examples**: https://simpleitk.readthedocs.io/
- **DICOM SR**: DICOM PS3.3 Structured Reporting

### é¡ä¼¼ç³»çµ±
- Siemens syngo.via
- FreeSurfer Longitudinal Stream
- BrainVoyager

## ğŸ“ è¯çµ¡è³‡è¨Š

### å°ˆæ¡ˆè² è²¬äºº
[å¾…æŒ‡æ´¾]

### æŠ€è¡“é¡§å•
[å¾…æŒ‡æ´¾]

### è‡¨åºŠé¡§å•
[å¾…æŒ‡æ´¾]

## ğŸ“… æ™‚é–“è»¸

| é€±æ¬¡ | éšæ®µ | é‡Œç¨‹ç¢‘ |
|------|------|--------|
| Week 1-2 | æ ¸å¿ƒæ¨¡çµ„é–‹ç™¼ | M1: é…æº–ã€åˆ†ææ¨¡çµ„å®Œæˆ |
| Week 3 | è¼¸å‡ºåŠŸèƒ½é–‹ç™¼ | M2: è¦–è¦ºåŒ–ã€å ±å‘Šã€DICOM |
| Week 4 | æ•´åˆèˆ‡æ¸¬è©¦ | M3: ç«¯åˆ°ç«¯å¯ç”¨ |
| Week 5 | è‡¨åºŠé©—è­‰ï¼ˆé¸ç”¨ï¼‰| M4: æº–å‚™ä¸Šç·š |

## âœ… ä¸‹ä¸€æ­¥è¡Œå‹•

1. **åœ˜éšŠæœƒè­°**: è¨è«–ææ¡ˆï¼Œç¢ºèªéœ€æ±‚èˆ‡æ™‚ç¨‹
2. **è³‡æºåˆ†é…**: æŒ‡æ´¾é–‹ç™¼äººå“¡èˆ‡æ™‚é–“
3. **ç’°å¢ƒæº–å‚™**: è¨­å®šé–‹ç™¼èˆ‡æ¸¬è©¦ç’°å¢ƒ
4. **é–‹å§‹å¯¦ä½œ**: åŸ·è¡Œ `/openspec:apply add-followup-comparison-module`

---

**ç‹€æ…‹**: ğŸŸ¢ å·²é‡æ–°è¦åŠƒï¼ˆæª”æ¡ˆå°å‘ç‰ˆæœ¬ï¼‰  
**å‰µå»ºæ—¥æœŸ**: 2025-11-28  
**æ›´æ–°æ—¥æœŸ**: 2025-11-28  
**é è¨ˆé–‹å§‹**: [å¾…å®š]  
**é è¨ˆå®Œæˆ**: [å¾…å®š] (+4-5 é€±)

## ğŸ”„ èˆ‡ pipeline_infarct_torch.py çš„å°æ¯”

| ç‰¹æ€§ | pipeline_infarct_torch.py | pipeline_followup.py |
|------|--------------------------|----------------------|
| è¼¸å…¥ | å–®æ¬¡æª¢æŸ¥ï¼ˆADC, DWI0, DWI1000ï¼‰ | å…©æ¬¡æª¢æŸ¥ï¼ˆå„å« Pred + åŸå§‹å½±åƒï¼‰ |
| è™•ç†éšæ®µ | å‰è™•ç† â†’ AIæ¨ç† â†’ å¾Œè™•ç† â†’ after_run | è¼‰å…¥é©—è­‰ â†’ é…æº– â†’ åˆ†æ â†’ è¼¸å‡º |
| æ ¸å¿ƒé‹ç®— | nnU-Net æ¨ç† | SimpleITK é…æº– + ç—…ç¶é…å° |
| è¼¸å‡º | Pred.nii.gz, JSON, DICOM-SEG | æ¯”è¼ƒ JSON, è¦–è¦ºåŒ–åœ–ç‰‡, DICOM-SEG |
| è³‡æ–™åº« | ç„¡ï¼ˆæª”æ¡ˆå°å‘ï¼‰| ç„¡ï¼ˆæª”æ¡ˆå°å‘ï¼‰|
| åŸ·è¡Œæ–¹å¼ | Shell è…³æœ¬ + Python | Shell è…³æœ¬ + Python |

