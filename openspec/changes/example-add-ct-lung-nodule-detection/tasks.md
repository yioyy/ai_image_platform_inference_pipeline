# 實作任務清單

## 1. 資料庫設定
- [ ] 1.1 創建 `lung_nodule_results` 資料表
- [ ] 1.2 新增資料庫遷移腳本
- [ ] 1.3 更新 ORM 模型（如使用 SQLAlchemy）
- [ ] 1.4 測試資料表建立與查詢

## 2. DICOM 前處理 (pre_lung.py)
- [ ] 2.1 實作 CT 胸腔序列檢測
  - 檢查 Modality = "CT"
  - 檢查 BodyPartExamined = "CHEST"
  - 驗證 ImageType 標籤
- [ ] 2.2 從 Orthanc 下載 DICOM 序列
- [ ] 2.3 轉換 DICOM 為 NIfTI 格式
  - 保持原始 Hounsfield 單位
  - 記錄 spacing 資訊
- [ ] 2.4 影像正規化與預處理
  - 肺窗調整（-1000 to 400 HU）
  - 重採樣至等向性體素（1mm³）
- [ ] 2.5 驗證輸入資料品質
  - 檢查切片數量（>50）
  - 檢查影像尺寸
  - 檢查 HU 值範圍

## 3. AI 模型整合 (gpu_lung.py)
- [ ] 3.1 下載並整合預訓練模型
  - 研究 LUNA16 預訓練權重
  - 放置於 `model_weights/lung_nodule/`
- [ ] 3.2 實作推理管道
  - 載入 nnU-Net 模型
  - 實作滑動窗口推理（處理大型 3D 影像）
  - GPU 記憶體管理
- [ ] 3.3 後處理預測結果
  - 連通元件分析
  - 過濾小體積偽陽性（<3mm）
  - 結節分類（實質性、磨玻璃樣、混合型）
- [ ] 3.4 提取結節特徵
  - 位置（中心座標）
  - 體積（cm³）
  - 最大直徑（mm）
  - 平均 HU 值
  - 類型分類

## 4. 結果後處理 (post_lung.py)
- [ ] 4.1 將分割遮罩轉回原始 DICOM 空間
- [ ] 4.2 產生 DICOM-SEG 檔案
  - 參考 `code_ai/pipeline/dicomseg/` 現有實作
  - 設定正確的 Segment 屬性
  - 包含結節測量資訊
- [ ] 4.3 更新資料庫記錄
  - 儲存結節數量
  - 儲存結節詳細資訊（JSON）
  - 記錄處理時間
- [ ] 4.4 上傳結果至 Orthanc
  - POST DICOM-SEG 至 Orthanc
  - 驗證上傳成功
  - 記錄 Instance UID

## 5. 整合管道腳本 (pipeline_lung.py)
- [ ] 5.1 實作主管道函數
  ```python
  def lung_nodule_pipeline(patient_id, study_uid, series_uid):
      # 前處理
      # 推理
      # 後處理
      # 錯誤處理
  ```
- [ ] 5.2 新增命令列參數解析
  - `--patient-id`
  - `--study-uid`
  - `--series-uid`
  - `--gpu-id`（預設: 0）
- [ ] 5.3 實作批次處理支援
- [ ] 5.4 新增進度條與日誌輸出
- [ ] 5.5 錯誤處理與重試邏輯

## 6. 工具函數 (utils)
- [ ] 6.1 實作 CT 影像品質檢查
  - 噪聲評估
  - 偽影檢測
- [ ] 6.2 實作結節視覺化工具
  - 產生帶有標記的 MIP（最大強度投影）影像
  - 產生 3D 渲染圖
- [ ] 6.3 實作結節追蹤比對工具（基礎版）
  - 比對前後檢查的結節位置
  - 計算體積變化率

## 7. 測試
- [ ] 7.1 單元測試
  - 測試 DICOM 序列檢測邏輯
  - 測試 NIfTI 轉換正確性
  - 測試結節特徵提取
  - 測試資料庫操作
- [ ] 7.2 整合測試
  - 使用測試資料集端到端測試
  - 驗證 DICOM-SEG 格式正確性
  - 測試 Orthanc 上傳流程
- [ ] 7.3 效能測試
  - 測量不同影像大小的處理時間
  - 監控 GPU 記憶體使用
  - 驗證批次處理效能
- [ ] 7.4 臨床驗證
  - 使用標註資料集計算 Dice 係數
  - 計算敏感度與特異度
  - 分析偽陽性/偽陰性案例

## 8. 文檔
- [ ] 8.1 更新 README.md
  - 新增肺部結節檢測說明
  - 新增使用範例
  - 新增 API 文檔
- [ ] 8.2 撰寫函數 Docstrings
  - 所有公開函數包含完整文檔
  - 包含參數說明與返回值
  - 包含使用範例
- [ ] 8.3 創建使用指南
  - 如何準備輸入資料
  - 如何解讀結果
  - 常見問題排解

## 9. 部署準備
- [ ] 9.1 更新依賴列表
  - requirements.txt
  - 註明 GPU 需求
- [ ] 9.2 準備模型權重下載腳本
- [ ] 9.3 創建部署檢查清單
- [ ] 9.4 準備監控儀表板（如有）

## 10. 程式碼審查與優化
- [ ] 10.1 Linus 風格檢查
  - 確保縮排 ≤3 層
  - 使用 Early Return
  - 資料結構驅動設計
- [ ] 10.2 效能優化
  - 識別瓶頸
  - 優化記憶體使用
  - 優化 I/O 操作
- [ ] 10.3 程式碼重構
  - 提取重複邏輯
  - 改進命名
  - 新增註解

## 進度追蹤
- **預計開始日期**: [待定]
- **預計完成日期**: [待定]
- **當前狀態**: 規劃階段
- **完成比例**: 0/47 (0%)

